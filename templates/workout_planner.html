{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <div class="card shadow-sm p-4 mx-auto" style="max-width: 800px; border: none; border-radius: 12px;">
        <div class="card-body">
            <h2 class="card-title text-info mb-3">Create Your Workout Plan</h2>
            <p class="card-subtitle mb-4 text-muted">
                Tell us your goals and available time to generate a personalized workout routine.
            </p>

            <!-- Workout Selection Form -->
            <form id="workout-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="goal" class="form-label fw-bold">Your Fitness Goal</label>
                        <select id="goal" name="goal" class="form-select" required>
                            <option value="Weight Loss">Weight Loss</option>
                            <option value="Muscle Building">Muscle Building</option>
                            <option value="General Fitness">General Fitness</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="level" class="form-label fw-bold">Your Fitness Level</label>
                        <select id="level" name="level" class="form-select" required>
                            <option value="Beginner">Beginner</option>
                            <option value="Intermediate">Active</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="duration" class="form-label fw-bold">Time per day</label>
                        <select id="duration" name="duration" class="form-select" required>
                            <option value="15-20">15-20 minutes</option>
                            <option value="30-40">30-40 minutes</option>
                        </select>
                    </div>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-info text-white btn-lg">Generate Workout</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Workout Result Container -->
    <div id="workout-result-container" class="mt-4" style="display: none;">
        <div class="card shadow-sm p-4 mx-auto" style="max-width: 800px; border: none; border-radius: 12px;">
            <div class="card-body" id="workout-result-content">
                <!-- Loading spinner and results will be injected here -->
            </div>
        </div>
    </div>
</div>

<!-- JavaScript to handle form submission and all actions -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('workout-form');
    const resultContainer = document.getElementById('workout-result-container');
    const resultContent = document.getElementById('workout-result-content');

    // --- START OF NEW HELPER FUNCTIONS ---
    function printWorkoutPlan() {
        const title = resultContent.querySelector('h3').innerText;
        const planContent = resultContent.querySelector('#workout-plan-content').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>${title}</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"><style>body{padding:2rem}.list-group-item{border:none;padding-left:0}</style></head><body><h2>${title}</h2><hr>${planContent}</body></html>`);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
    }

    function getShareableWorkoutText() {
        const title = resultContent.querySelector('h3').innerText;
        let exercisesText = '';
        const exercises = resultContent.querySelectorAll('#workout-plan-content .list-group-item');
        exercises.forEach(item => {
            const name = item.querySelector('span:first-child').innerText;
            const reps = item.querySelector('span.badge').innerText;
            exercisesText += `- ${name} (${reps})\n`;
        });
        return `My Helio Workout Plan: ${title}\n\n${exercisesText}`;
    }

    function copyWorkoutPlan(buttonElement) {
        const text = getShareableWorkoutText();
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = `<i class="bi bi-check-lg"></i> Copied!`;
        buttonElement.classList.add('disabled');
        setTimeout(() => {
            buttonElement.innerHTML = originalText;
            buttonElement.classList.remove('disabled');
        }, 2000);
    }

    function nativeShareWorkoutPlan() {
        if (navigator.share) {
            navigator.share({ title: 'My Helio Workout Plan', text: getShareableWorkoutText() }).catch(console.error);
        }
    }
    // --- END OF NEW HELPER FUNCTIONS ---


    form.addEventListener('submit', function(event) {
        event.preventDefault();
        resultContainer.style.display = 'block';
        resultContent.innerHTML = `<div class="text-center"><div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Finding the best workout for you...</p></div>`;
        const formData = new FormData(form);
        const url = new URL("{{ url_for('workout_planner') }}", window.location.origin);
        url.searchParams.append('goal', formData.get('goal'));
        url.searchParams.append('level', formData.get('level'));
        url.searchParams.append('duration', formData.get('duration'));
        url.searchParams.append('json', 'true');

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.plan) {
                    const workout = data.plan;
                    const nativeShareSupported = navigator.share ? '' : 'd-none';
                    let exercisesHtml = '';
                    workout.plan.forEach(exercise => {
                        exercisesHtml += `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${exercise.name}</span><span class="badge bg-primary rounded-pill">${exercise.reps_or_duration}</span></li>`;
                    });
                    // MODIFIED: Added action buttons and wrapper div
                    resultContent.innerHTML = `
                        <div id="workout-plan-content">
                            <h3 class="text-info">${workout.title}</h3>
                            <p class="text-muted">${workout.description}</p>
                            <hr>
                            <ul class="list-group list-group-flush">${exercisesHtml}</ul>
                        </div>
                        <div class="d-flex justify-content-start align-items-center gap-2 mt-4 flex-wrap">
                           <button id="save-workout-btn" class="btn btn-sm btn-outline-primary"><i class="bi bi-bookmark"></i> Save Workout</button>
                           <button id="print-workout-btn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-printer"></i> Print/Download</button>
                           <div class="btn-group">
                              <button type="button" class="btn btn-sm btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-share"></i> Share
                              </button>
                              <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="copy-workout-btn"><i class="bi bi-clipboard"></i> Copy to Clipboard</a></li>
                                <li class="${nativeShareSupported}"><a class="dropdown-item" href="#" id="native-share-workout-btn"><i class="bi bi-three-dots"></i> More Options...</a></li>
                              </ul>
                            </div>
                        </div>`;
                } else {
                    resultContent.innerHTML = `<div class="alert alert-warning">${data.message || 'Sorry, no workout plan found for your selection.'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching workout:', error);
                resultContent.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
            });
    });

    resultContent.addEventListener('click', function(event) {
        const saveButton = event.target.closest('#save-workout-btn');
        // MODIFIED: Added listeners for new buttons
        const printButton = event.target.closest('#print-workout-btn');
        const copyButton = event.target.closest('#copy-workout-btn');
        const nativeShareButton = event.target.closest('#native-share-workout-btn');

        if (saveButton) {
            const title = resultContent.querySelector('h3').innerText;
            const description = resultContent.querySelector('p').innerText;
            const exercises = Array.from(resultContent.querySelectorAll('.list-group-item')).map(item => ({
                name: item.querySelector('span:first-child').innerText,
                reps_or_duration: item.querySelector('span.badge').innerText
            }));
            const payload = { title, description, plan: exercises };
            
            fetch("{{ url_for('save_workout') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    saveButton.innerHTML = `<i class="bi bi-bookmark-check-fill"></i> Saved!`;
                    saveButton.classList.remove('btn-outline-primary');
                    saveButton.classList.add('btn-primary', 'disabled');
                } else {
                    alert(data.message || 'Could not save the workout.');
                }
            })
            .catch(error => {
                console.error('Error saving workout:', error);
                alert('An error occurred while saving the workout.');
            });
        }
        
        // MODIFIED: Added event handlers
        if (printButton) {
            printWorkoutPlan();
        }
        if (copyButton) {
            event.preventDefault();
            copyWorkoutPlan(copyButton);
        }
        if (nativeShareButton) {
            event.preventDefault();
            nativeShareWorkoutPlan();
        }
    });
});
</script>

{% endblock %}

